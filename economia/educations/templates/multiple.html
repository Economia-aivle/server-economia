<!DOCTYPE html>
{% load static %}
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>문제풀이 - OX</title>
    <link rel="stylesheet" href="{% static 'multiple.css' %}" />
    <link rel="stylesheet" href="{% static 'wrong_explanation.css' %}">
</head>

<body>
    {% include 'quiz_header2.html' %}
    <main>
        <div class="wrap-container">
            <div class="question-container">
                <h1>Q{{ num }}. {{ question.question_text }}</h1>
            </div>
            <div class="character" onclick="submitAnswer()">
                <img src="{% static 'images/char1.png' %}" alt="char" />
            </div>
            <div class="answer-container">
                <form id="answer-form" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="answer" name="answer" value="">
                    <button class="option-btn" type="button" id="option1" onclick="selectOption(this)" name="answer" value="1">1. {{ question.option_a }}</button>
                    <button class="option-btn" type="button" id="option2" onclick="selectOption(this)" name="answer" value="2">2. {{ question.option_b }}</button>
                    <button class="option-btn" type="button" id="option3" onclick="selectOption(this)" name="answer" value="3">3. {{ question.option_c }}</button>
                    <button class="option-btn" type="button" id="option4" onclick="selectOption(this)" name="answer" value="4">4. {{ question.option_d }}</button>
                </form>
            </div>
        </div>
        <div class="wrong-container" id="wrong-container" style="display:none;">
            <div class="question-container">
                <h1>Q{{ num }}. {{ question.question_text }}</h1>
            </div>
            <div class="answer-bubble">
                <p class="ans">답: {{ question.correct_answer }}</p>
                <p>{{ question.explanation }}</p>
            </div>
            <div class="character">
                <img src="{% static 'images/char1.png' %}" alt="char" />
            </div>
            <div class="next-button-container">
                <button class="next" id="next-btn" onclick="nextQuestion()">{% if num == 5 %}Finish{% else %}다음문제{% endif %}</button>
            </div>
        </div>
    </main>
    <aside class="sidebar">
        <div class="top-num"><p class="progress-num">{{ num }}/5</p></div>
        <div class="progress">
            <a href="#" class="progress-step  {% if num >= 1 %}active{% endif %}" id="step-1"></a>
            <a href="#" class="progress-step  {% if num >= 2 %}active{% endif %}" id="step-2"></a>
            <a href="#" class="progress-step  {% if num >= 3 %}active{% endif %}" id="step-3"></a>
            <a href="#" class="progress-step  {% if num >= 4 %}active{% endif %}" id="step-4"></a>
            <a href="#" class="progress-step  {% if num >= 5 %}active{% endif %}" id="step-5"></a>
        </div>
    </aside>

    <script>
        let selectedOption = null;
        const characters = "{{ characters }}";
        const subject = "{{ subject }}";
        const chapter = "{{ chapter }}";
        const num = {{ num }};
        
        function selectOption(selectedBtn) {
            // 모든 버튼의 selected 클래스를 제거
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 클릭한 버튼에 selected 클래스 추가
            selectedBtn.classList.add('selected');
            selectedOption = selectedBtn;
        }

        function submitAnswer() {
          var num = {{ num }};
            if (!selectedOption) {
                alert('정답을 선택해주세요.');
                return;
            }

            const selectedAnswer = selectedOption.value;

            // AJAX를 이용한 POST 요청
            const formData = new FormData();
            formData.append('answer', selectedAnswer);

            fetch(`/educations/multiple/${characters}/${subject}/${chapter}/${num}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'complete') {
                    alert(data.message);
                    window.location.href = "{% url 'educations:level_choice' characters=characters subject=subject chapter=chapter %}";
                } else if (data.status === 'wrong') {
                    alert(data.message);
                    document.querySelector('.wrap-container').style.display = 'none';
                    document.getElementById('wrong-container').style.display = 'block';
                }else if (data.status === 'fail') {
                  alert(data.message);
                  window.location.href = "{% url 'educations:level_choice' characters=characters subject=subject chapter=chapter %}";
              }  
                else {
                  
                    alert(data.message);
                    // 다음 문제로 넘어감
                    window.location.href = `/educations/multiple/${characters}/${subject}/${chapter}/${num + 1}`;
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function nextQuestion() {
            if (num >= 5) {
                window.location.href = "{% url 'educations:level_choice' characters=characters subject=subject chapter=chapter %}";
            } else {
                window.location.href = `/educations/multiple/${characters}/${subject}/${chapter}/${num + 1}`;
            }
        }


        window.onload = function() {


          function redirectToLevelChoice() {
              var levelChoiceUrl = "{% url 'educations:level_choice' characters=characters subject=subject chapter=chapter %}";
              window.location.href = levelChoiceUrl;
          }

          var currentUrl = window.location.href;
          var levelChoiceUrlPattern = "{% url 'educations:level_choice' characters=characters subject=subject chapter=chapter %}";

          if (currentUrl !== levelChoiceUrlPattern) {
              history.pushState(null, null, levelChoiceUrlPattern);
          }

          window.addEventListener('popstate', function() {
              if (window.location.href !== levelChoiceUrlPattern) {
                  location.replace(levelChoiceUrlPattern);
              }
          });
      };
    </script>
</body>
</html>
